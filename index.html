<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Danh sách món ăn</title>
  <link rel="manifest" href="manifest.json" />
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log("✅ Service Worker Registered!"));
    }
  </script>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 1rem;
      background-color: #f9f9f9;
      color: #333;
    }
    h3 {
      margin-top: 2rem;
    }
    details {
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 1rem;
    }
    input, select, button {
      padding: 0.5rem;
      margin: 0.25rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
    }
    button {
      cursor: pointer;
      background-color: #007bff;
      color: white;
      border: none;
    }
    button:hover {
      background-color: #0056b3;
    }
    button.danger {
      background-color: #dc3545;
    }
    button.danger:hover {
      background-color: #c82333;
    }
    .group-section, .output-section {
      margin-bottom: 2rem;
    }
    .group {
      background: #fff;
      padding: 1rem;
      border: 1px solid #ddd;
      border-radius: 6px;
      margin-bottom: 1rem;
    }
    .item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.25rem;
    }
    .item span.name {
      flex: 1;
      cursor: pointer;
    }
    .group summary span.name {
      font-weight: bold;
      cursor: pointer;
    }
    .output-section pre {
      background-color: #efefef;
      padding: 1rem;
      border-radius: 6px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <details open>
    <summary><strong>Thêm nhóm & món ăn</strong></summary>
    <div class="group-section">
      <input id="groupName" placeholder="Tên nhóm" onkeydown="handleEnter(event, 'addGroup')" />
      <button onclick="addGroup()">Thêm nhóm</button>
    </div>
    <div class="group-section">
      <input id="itemName" placeholder="Tên món ăn" onkeydown="handleEnter(event, 'addItem')" />
      <input id="itemDesc" placeholder="Mô tả món (tuỳ chọn)" />
      <select id="groupSelect"></select>
      <button class="danger" onclick="addItem()">Thêm món</button>
    </div>
  </details>

  <div id="groupList" class="group-section"></div>

  <div class="output-section">
    <h3>Danh sách cần tắt:</h3>
    <pre id="output"></pre>
    <button onclick="generateList()">Tạo danh sách cần tắt</button>
    <button onclick="copyToClipboard()">Copy</button>
    <button onclick="downloadJSON()">Xuất dữ liệu</button>
    <input type="file" onchange="loadJSON(event)" />
  </div>

  <script>
    let data = {};

    function handleEnter(e, action) {
      if (e.key === 'Enter') {
        e.preventDefault();
        if (action === 'addGroup') addGroup();
        else if (action === 'addItem') addItem();
      }
    }

    function addGroup() {
      const name = document.getElementById('groupName').value.trim();
      if (!name || data[name]) return;
      data[name] = [];
      document.getElementById('groupName').value = '';
      updateGroups();
    }

    function addItem() {
      const name = document.getElementById('itemName').value.trim();
      const desc = document.getElementById('itemDesc').value.trim();
      const group = document.getElementById('groupSelect').value;
      if (!name || !group) return;
      data[group].push({ name, desc, checked: true });
      document.getElementById('itemName').value = '';
      document.getElementById('itemDesc').value = '';
      updateGroups();
    }

    function updateGroups() {
      const groupList = document.getElementById('groupList');
      const groupSelect = document.getElementById('groupSelect');
      const currentSelection = groupSelect.value;
      groupList.innerHTML = '';
      groupSelect.innerHTML = '';
      Object.keys(data).forEach(group => {
        groupSelect.innerHTML += `<option>${group}</option>`;
        const groupDiv = document.createElement('details');
        groupDiv.className = 'group';
        groupDiv.innerHTML = `
          <summary>
            <span class="name" onclick="toggleGroupVisibility(event)">${group}</span>
            <button onclick="renameGroupPrompt('${group}')">✏️</button>
            <button class="danger" onclick="removeGroup('${group}')">Xóa nhóm</button>
          </summary>
          <div id="group-${group}"></div>
        `;
        groupList.appendChild(groupDiv);
        const itemsContainer = groupDiv.querySelector(`#group-${CSS.escape(group)}`);
        data[group].forEach((item, index) => {
          const div = document.createElement('div');
          div.className = 'item';
          div.innerHTML = `
            <button onclick="renameItemPrompt('${group}', ${index})">✏️</button>
            <button class="danger" onclick="removeItem('${group}', ${index})">X</button>
            <span class="name" onclick="toggleItem('${group}', ${index}, event)">${item.name}</span>
            <input type="checkbox" ${item.checked ? 'checked' : ''} onchange="toggleCheck('${group}', ${index}, this.checked)" />
          `;
          itemsContainer.appendChild(div);
        });
      });
      groupSelect.value = currentSelection;
    }

    function toggleGroupVisibility(event) {
      event.stopPropagation();
    }

    function toggleItem(group, index, event) {
      event.stopPropagation();
      data[group][index].checked = !data[group][index].checked;
      updateGroups();
    }

    function toggleCheck(group, index, value) {
      data[group][index].checked = value;
    }

    function renameGroupPrompt(oldName) {
      const newName = prompt("Đổi tên nhóm:", oldName);
      if (newName && newName !== oldName && !data[newName]) {
        data[newName] = data[oldName];
        delete data[oldName];
        updateGroups();
      }
    }

    function renameItemPrompt(group, index) {
      const oldName = data[group][index].name;
      const newName = prompt("Đổi tên món:", oldName);
      if (newName && newName !== oldName) {
        data[group][index].name = newName;
        updateGroups();
      }
    }

    function removeGroup(name) {
      delete data[name];
      updateGroups();
    }

    function removeItem(group, index) {
      data[group].splice(index, 1);
      updateGroups();
    }

    function generateList() {
      const output = [];
      Object.keys(data).forEach(group => {
        const uncheckedItems = data[group].filter(item => !item.checked);
        if (uncheckedItems.length) {
          output.push(`${group}:`);
          uncheckedItems.forEach(item => {
            output.push(`- ${item.name}`);
          });
        }
      });
      document.getElementById('output').textContent = output.join('\n');
    }

    function copyToClipboard() {
      const text = document.getElementById('output').textContent;
      const temp = document.createElement("textarea");
      temp.value = text;
      document.body.appendChild(temp);
      temp.select();
      temp.setSelectionRange(0, 99999);
      document.execCommand("copy");
      document.body.removeChild(temp);
      alert("✅ Danh sách đã được sao chép!");
    }

    function downloadJSON() {
      const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'menu.json';
      a.click();
    }

    function loadJSON(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const json = JSON.parse(e.target.result);
          data = json;
          updateGroups();
        } catch (err) {
          alert('Lỗi khi đọc file JSON');
        }
      };
      reader.readAsText(file);
    }

    window.addEventListener('load', async () => {
      try {
        const res = await fetch('menu.json');
        if (!res.ok) throw new Error('Không tìm thấy menu.json');
        data = await res.json();
        updateGroups();
      } catch (err) {
        alert("⚠ Không thể tải dữ liệu từ menu.json");
        console.error(err);
      }
    });
  </script>
</body>
</html>