<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Danh sÃ¡ch mÃ³n Äƒn</title>
  <link rel="manifest" href="manifest.json" />
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log("âœ… Service Worker Registered!"));
    }
  
function toggleMenu(btn) {
  const popup = btn.nextElementSibling;
  const openMenus = document.querySelectorAll('.menu-popup');
  openMenus.forEach(el => { if (el !== popup) el.style.display = 'none'; });
  popup.style.display = popup.style.display === 'block' ? 'none' : 'block';
}
document.addEventListener('click', function(e) {
  if (!e.target.closest('.menu-wrapper')) {
    document.querySelectorAll('.menu-popup').forEach(p => p.style.display = 'none');
  }
});


document.addEventListener('DOMContentLoaded', () => {
  const savedStates = JSON.parse(localStorage.getItem("groupStates") || "{}");
  Object.entries(savedStates).forEach(([id, isOpen]) => {
    const el = document.getElementById(id);
    if (el) el.open = isOpen;
  });
});
document.addEventListener("toggle", (e) => {
  if (e.target.tagName === "DETAILS") {
    const all = document.querySelectorAll("details[id^='group-']");
    const states = {};
    all.forEach(d => states[d.id] = d.open);
    localStorage.setItem("groupStates", JSON.stringify(states));
  }
});

</script>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, sans-serif;
      margin: 0;
      padding: 2rem;
      background: #f0f4f8;
      color: #333;
    }
    h2 {
      margin-bottom: 1rem;
    }
    input, select, button {
      padding: 0.5rem;
      margin: 0.25rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }
    button {
      background: #007bff;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    button.danger {
      background: #dc3545;
    }
    button.danger:hover {
      background: #a71d2a;
    }
    .control-bar {
      background: #fff;
      padding: 1rem;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }
    details {
      border: 1px solid #ccc;
      border-radius: 10px;
      background: #fff;
      margin-bottom: 1rem;
    }
    summary {
      font-weight: bold;
      padding: 1rem;
      cursor: pointer;
      outline: none;
      background: #e9f2fb;
      border-bottom: 1px solid #ccc;
    }
    .group-tools, .output-section {
      display: flex;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      flex-wrap: wrap;
      align-items: center;
    }
    .group-items {
      padding: 0 1rem 1rem;
    }
    .item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    .item span.name {
      flex: 1;
      cursor: pointer;
    }
    .output-section {
      flex-direction: column;
      align-items: flex-start;
    }
    .output-section pre {
      background: #eee;
      padding: 1rem;
      white-space: pre-wrap;
      border-radius: 6px;
      width: 100%;
    }
    .undo-bar {
      background: #fff3cd;
      color: #856404;
      padding: 0.75rem 1rem;
      margin: 1rem 0;
      border: 1px solid #ffeeba;
      border-radius: 6px;
      display: none;
      justify-content: space-between;
      align-items: center;
    }
    .undo-bar button {
      background: #ffc107;
      color: #000;
    }
  </style>
</head>
<body>
  <h2>Quáº£n lÃ½ danh sÃ¡ch mÃ³n Äƒn</h2>

  <div class="control-bar">
    <input id="groupName" placeholder="TÃªn nhÃ³m" />
    <button onclick="addGroup()">â• ThÃªm nhÃ³m</button>
    <br/><br/>
    <input id="itemName" placeholder="TÃªn mÃ³n Äƒn" />
    <input id="itemDesc" placeholder="MÃ´ táº£ (tuá»³ chá»n)" />
    <select id="groupSelect"></select>
    <button onclick="addItem()">ğŸ½ï¸ ThÃªm mÃ³n</button>
  </div>

  <div id="undoBar" class="undo-bar">
    <span>ÄÃ£ xoÃ¡. Báº¡n cÃ³ muá»‘n hoÃ n tÃ¡c?</span>
    <button onclick="undo()">â†©ï¸ HoÃ n tÃ¡c</button>
  </div>

  <div id="groupList"></div>

  <div class="output-section">
    <h3>Danh sÃ¡ch cáº§n táº¯t:</h3>
    <pre id="output"></pre>
    <div>
      <button onclick="generateList()">ğŸ“„ Táº¡o danh sÃ¡ch</button>
      <button onclick="resetAllChecks()">âœ… TÃ­ch táº¥t cáº£</button>
      <button onclick="copyToClipboard()">ğŸ“‹ Copy</button>
      <button onclick="downloadJSON()">ğŸ’¾ Táº£i JSON</button>
      <input type="file" onchange="loadJSON(event)" />
    </div>
  </div>

<script>
let data = {};
let undoStack = [];

function addGroup() {
  const name = document.getElementById('groupName').value.trim();
  if (!name || data[name]) return;
  data[name] = [];
  if (!data._order) data._order = [];
  data._order.push(name);
  document.getElementById('groupName').value = '';
  updateGroups();
}

function addItem() {
  const name = document.getElementById('itemName').value.trim();
  const desc = document.getElementById('itemDesc').value.trim();
  const group = document.getElementById('groupSelect').value;
  if (!name || !group) return;
  data[group].push({ name, desc, checked: true });
  document.getElementById('itemName').value = '';
  document.getElementById('itemDesc').value = '';
  updateGroups();
}

function updateGroups() {
  
  const previousStates = {};
  document.querySelectorAll('details[id^="group-"]').forEach(d => {
    previousStates[d.id] = d.open;
  });

const groupList = document.getElementById('groupList');
  const groupSelect = document.getElementById('groupSelect');
  const currentSelection = groupSelect.value;
  groupList.innerHTML = '';
  groupSelect.innerHTML = '';
  const order = data._order || Object.keys(data).filter(k => k !== "_order");

  order.forEach(group => {
    groupSelect.innerHTML += `<option>${group

  for (const id in previousStates) {
    const el = document.getElementById(id);
    if (el) el.open = previousStates[id];
  }
}</option>`;
    const details = document.createElement("details");
    details.open = true;
    details.innerHTML = `
      <summary>${group}</summary>
      <div class="group-tools">
        <button onclick="renameGroupPrompt('${group}')">âœï¸</button>
        <button class="danger" onclick="removeGroup('${group}')">ğŸ—‘ï¸</button>
        <button onclick="moveGroup('${group}', -1)">â¬†ï¸</button>
        <button onclick="moveGroup('${group}', 1)">â¬‡ï¸</button>
      </div>
      <div class="group-items" id="group-${group}"></div>
    `;
    groupList.appendChild(details);
    const itemsContainer = details.querySelector(`#group-${CSS.escape(group)}`);
    data[group].forEach((item, index) => {
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `
  <div class="menu-wrapper" style="display:flex; align-items:center; gap:4px;">
    <button class="menu-btn" onclick="toggleMenu(this)">â‹®</button>
    <div class="menu-popup" style="display:none; position:absolute; background:white; border:1px solid #ccc; border-radius:6px; box-shadow:0 2px 8px rgba(0,0,0,0.15); padding:4px; z-index:1000;">
      <button onclick="renameItemPrompt('${group}', ${index})">âœï¸ Äá»•i tÃªn</button><br>
      <button onclick="removeItem('${group}', ${index})">ğŸ—‘ï¸ XoÃ¡</button><br>
      <button onclick="moveItem('${group}', ${index}, -1)">â¬†ï¸ LÃªn</button><br>
      <button onclick="moveItem('${group}', ${index}, 1)">â¬‡ï¸ Xuá»‘ng</button>
    </div>
  </div>
  <span class="name" onclick="toggleItem('${group}', ${index}, event)">${item.name}</span>
  <input type="checkbox" ${item.checked ? 'checked' : ''} onchange="toggleCheck('${group}', ${index}, this.checked)" />
`;
      itemsContainer.appendChild(div);
    });
  });
  groupSelect.value = currentSelection;
}

function toggleItem(group, index, event) {
  event.stopPropagation();
  data[group][index].checked = !data[group][index].checked;
  updateGroups();
}

function toggleCheck(group, index, value) {
  data[group][index].checked = value;
}

function renameItemPrompt(group, index) {
  const oldName = data[group][index].name;
  const newName = prompt("Äá»•i tÃªn mÃ³n:", oldName);
  if (newName && newName !== oldName) {
    data[group][index].name = newName;
    updateGroups();
  }
}

function removeItem(group, index) {
  const removed = data[group].splice(index, 1)[0];
  undoStack.push({ type: "item", group, index, item: removed });
  showUndoBar();
  updateGroups();
}

function renameGroupPrompt(oldName) {
  const newName = prompt("Äá»•i tÃªn nhÃ³m:", oldName);
  if (newName && newName !== oldName && !data[newName]) {
    data[newName] = data[oldName];
    delete data[oldName];
    const idx = data._order.indexOf(oldName);
    if (idx >= 0) data._order[idx] = newName;
    updateGroups();
  }
}

function removeGroup(name) {
  const backup = { name, items: data[name], index: data._order.indexOf(name) };
  delete data[name];
  data._order = data._order.filter(g => g !== name);
  undoStack.push({ type: "group", group: backup });
  showUndoBar();
  updateGroups();
}

function moveItem(group, index, direction) {
  const newIndex = index + direction;
  if (newIndex < 0 || newIndex >= data[group].length) return;
  [data[group][index], data[group][newIndex]] = [data[group][newIndex], data[group][index]];
  updateGroups();
}

function moveGroup(group, direction) {
  const idx = data._order.indexOf(group);
  const newIndex = idx + direction;
  if (newIndex < 0 || newIndex >= data._order.length) return;
  [data._order[idx], data._order[newIndex]] = [data._order[newIndex], data._order[idx]];
  updateGroups();
}

function resetAllChecks() {
  Object.keys(data).forEach(group => {
    data[group].forEach(item => item.checked = true);
  });
  updateGroups();
}

function generateList() {
  const output = [];
  const order = data._order || Object.keys(data).filter(k => k !== "_order");
  order.forEach(group => {
    const uncheckedItems = data[group].filter(item => !item.checked);
    if (uncheckedItems.length) {
      output.push(`${group}:`);
      uncheckedItems.forEach(item => output.push(`- ${item.name}`));
    }
  });
  document.getElementById('output').textContent = output.join('\n');
}

function copyToClipboard() {
  const text = document.getElementById('output').textContent;
  const temp = document.createElement("textarea");
  temp.value = text;
  document.body.appendChild(temp);
  temp.select();
  document.execCommand("copy");
  document.body.removeChild(temp);
  alert("âœ… Danh sÃ¡ch Ä‘Ã£ sao chÃ©p!");
}

function downloadJSON() {
  const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'menu.json';
  a.click();
}

function loadJSON(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function (e) {
    try {
      data = JSON.parse(e.target.result);
      updateGroups();
    } catch {
      alert("Lá»—i khi Ä‘á»c file JSON");
    }
  };
  reader.readAsText(file);
}

function showUndoBar() {
  document.getElementById('undoBar').style.display = 'flex';
}

function undo() {
  const last = undoStack.pop();
  if (!last) return;
  if (last.type === 'item') {
    data[last.group].splice(last.index, 0, last.item);
  } else if (last.type === 'group') {
    data[last.group.name] = last.group.items;
    data._order.splice(last.group.index, 0, last.group.name);
  }
  updateGroups();
  document.getElementById('undoBar').style.display = 'none';
}

window.addEventListener("load", async () => {
  try {
    const res = await fetch('https://ebolakakaha.github.io/Menu/menu.json');
    if (!res.ok) throw new Error("KhÃ´ng tÃ¬m tháº¥y menu.json");
    data = await res.json();
    updateGroups();
  } catch {
    alert("âš  KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u tá»« menu.json");
  }
});

function toggleMenu(btn) {
  const popup = btn.nextElementSibling;
  const openMenus = document.querySelectorAll('.menu-popup');
  openMenus.forEach(el => { if (el !== popup) el.style.display = 'none'; });
  popup.style.display = popup.style.display === 'block' ? 'none' : 'block';
}
document.addEventListener('click', function(e) {
  if (!e.target.closest('.menu-wrapper')) {
    document.querySelectorAll('.menu-popup').forEach(p => p.style.display = 'none');
  }
});


document.addEventListener('DOMContentLoaded', () => {
  const savedStates = JSON.parse(localStorage.getItem("groupStates") || "{}");
  Object.entries(savedStates).forEach(([id, isOpen]) => {
    const el = document.getElementById(id);
    if (el) el.open = isOpen;
  });
});
document.addEventListener("toggle", (e) => {
  if (e.target.tagName === "DETAILS") {
    const all = document.querySelectorAll("details[id^='group-']");
    const states = {};
    all.forEach(d => states[d.id] = d.open);
    localStorage.setItem("groupStates", JSON.stringify(states));
  }
});

</script>
</body>
</html>